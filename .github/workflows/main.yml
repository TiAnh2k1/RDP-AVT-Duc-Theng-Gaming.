name: üöÄ AVT Duc Theng Gaming üöÄ

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 

    steps:
      # 1. K·∫øt n·ªëi v√†o m·∫°ng Tailscale (Kh√¥ng ƒë·ªïi)
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }} 
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}       
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: latest
          hostname: github-vps-windows

      # 2. C·∫•u h√¨nh T√†i kho·∫£n, RDP, SSH, v√† Banner
      - name: Configure User, RDP and SSH
        env:
          USER_PASSWORD: ${{ secrets.RDP_PASSWORD }} 
        run: |
          $NewUser = "DucThengGaming"
          $NewPass = $env:USER_PASSWORD
          $SecurePass = ConvertTo-SecureString $NewPass -AsPlainText -Force

          # A. T·∫°o/C·∫≠p nh·∫≠t t√†i kho·∫£n
          if (-not (Get-LocalUser -Name $NewUser -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $NewUser -Password $SecurePass -FullName "Gaming VPS User" -Description "Custom GitHub RDP User"
            Add-LocalGroupMember -Group "Administrators" -Member $NewUser
          } else {
            Set-LocalUser -Name $NewUser -Password $SecurePass
          }

          # B. T·∫°o RDP INTRO/PREMIUM SI√äU X·ªäN
          $IntroTitle = "üíé VPS PREMIUM SI√äU X·ªäN: DUC THENG GAMING! üíé"
          $IntroText = "WELCOME, BOSS! ƒê√¢y l√† m·ªôt phi√™n l√†m vi·ªác mi·ªÖn ph√≠, gi·ªõi h·∫°n 6 ti·∫øng. Vui l√≤ng T·∫¨N D·ª§NG T·ªêI ƒêA t√†i nguy√™n v√† l∆∞u tr·ªØ d·ªØ li·ªáu an to√†n. Ch√∫c b·∫°n c√≥ tr·∫£i nghi·ªám tuy·ªát v·ªùi!"
          
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "legalnoticecaption" -Value $IntroTitle
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "legalnoticetext" -Value $IntroText
          
          # C. B·∫≠t RDP v√† SSH
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
          
          Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
          Set-Service -Name sshd -StartupType Automatic
          Start-Service sshd
          New-NetFirewallRule -Name "SSH Access" -DisplayName "SSH Access" -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22

      # 3. D·ªçn d·∫πp h·ªá th·ªëng
      - name: System Optimization (Cleanup)
        run: |
          Write-Host "B·∫Øt ƒë·∫ßu d·ªçn d·∫πp file r√°c h·ªá th·ªëng..."
          Remove-Item -Path C:\Windows\Temp\* -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $env:TEMP\* -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "D·ªçn d·∫πp ho√†n t·∫•t!"

      # ** 4. B∆Ø·ªöC M·ªöI: C√†i ƒë·∫∑t v√† ch·∫°y Container Linux (Ubuntu) **
      - name: Run Linux Container (Ubuntu)
        run: |
          Write-Host "K√≠ch ho·∫°t support Linux Container..."
          # L·ªánh n√†y s·∫Ω t·∫£i image v√† ch·∫°y m·ªôt container Ubuntu ·ªü ch·∫ø ƒë·ªô n·ªÅn.
          # L·ªánh 'sleep infinity' gi√∫p container ho·∫°t ƒë·ªông li√™n t·ª•c.
          docker run -d --name linux_support --restart always ubuntu:latest sleep infinity
          Write-Host "Container Linux 'linux_support' (Ubuntu) ƒë√£ ho·∫°t ƒë·ªông ·ªü ch·∫ø ƒë·ªô n·ªÅn."
          Write-Host "Truy c·∫≠p b·∫±ng l·ªánh: docker exec -it linux_support bash"

      # 5. Hi·ªÉn th·ªã th√¥ng b√°o h∆∞·ªõng d·∫´n
      - name: H∆∞·ªõng d·∫´n k·∫øt n·ªëi v√† s·ª≠ d·ª•ng Linux
        run: |
          Write-Host "==================================================="
          Write-Host "VPS ƒê√É S·∫¥N S√ÄNG! (Th·ªùi gian ch·∫°y t·ªëi ƒëa: ${{ github.job.timeout-minutes }} ph√∫t)"
          Write-Host "1. M·ªü Tailscale tr√™n m√°y t√≠nh c·ªßa b·∫°n."
          Write-Host "2. T√¨m thi·∫øt b·ªã c√≥ t√™n: github-vps-windows"
          Write-Host "3. Copy ƒë·ªãa ch·ªâ IP c·ªßa n√≥ (th∆∞·ªùng l√† 100.x.x.x)."
          Write-Host ""
          Write-Host "‚ñ∂ TH√îNG TIN ƒêƒÇNG NH·∫¨P:"
          Write-Host "   User: DucThengGaming"
          Write-Host "   Pass: (D√πng m·∫≠t kh·∫©u b·∫°n ƒë√£ ƒë·∫∑t trong Secret RDP_PASSWORD)"
          Write-Host ""
          Write-Host "‚ñ∂ K·∫øt n·ªëi RDP (GUI) ho·∫∑c SSH (CLI)."
          Write-Host ""
          Write-Host "*** S·ª¨ D·ª§NG M√îI TR∆Ø·ªúNG LINUX (UBUNTU) ***"
          Write-Host "   Sau khi k·∫øt n·ªëi RDP/SSH, g√µ l·ªánh sau ƒë·ªÉ v√†o Ubuntu:"
          Write-Host "   docker exec -it linux_support bash"
          Write-Host "==================================================="

      # 6. Treo m√°y (Keep Alive)
      - name: Keep Alive
        run: |
          Write-Host "ƒêang ch·∫°y... ƒê·ª´ng ƒë√≥ng tab n√†y."
          while ($true) {
            Start-Sleep -Seconds 60
          }
